(self.webpackChunkgeo_view=self.webpackChunkgeo_view||[]).push([[253],{6253:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>_});var a=n(4575),r=n.n(a),i=n(3913),s=n.n(i),l=n(9713),o=n.n(l),c=n(5893),u=n(3137),d=n(319),f=n.n(d),p=n(7757),y=n.n(p),m=n(8926),x=n.n(m),b=n(3038),h=n.n(b),g=n(7294),I=n(1120),v=(0,I.Z)((function(e){return{layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3,border:"none",width:"100%"},layerParentText:{fontSize:"16px",fontWeight:"bold"},layerCountTextContainer:{display:"flex",alignItems:"center",width:"100%"},layerFeatureCount:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)",marginRight:"10px",color:"black",fontSize:"16px",fontWeight:"bold"},layerItemText:{fontSize:"14px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"}}}));const k=function(e){var t=e.layersData,n=e.selectFeature,a=e.selectLayer,r=e.getSymbol,i=e.clickPos,s=e.mapId,l=v(),o=function(e,t){var i=e.layers[t],s=i.layerData,l=i.displayField,o=i.fieldAliases,c=i.renderer;a(e.layers[t]),1===s.length&&n({attributes:s[0].attributes,displayField:l,fieldAliases:o,symbol:r(c,s[0].attributes),numOfEntries:1})};return(0,c.jsx)("div",{className:l.layersContainer,children:Object.keys(t).map((function(e){var n=t[e];return(0,c.jsx)("div",{children:Object.keys(n.layers).map((function(e,t){var a=n.layers[e],d=a.layer,f=a.layerData,p=a.groupLayer;return(0,c.jsx)("div",{tabIndex:f.length>0&&!p?0:-1,onKeyDown:function(t){"Enter"===t.key&&(p||o(n,e))},role:"button",children:p?(0,c.jsx)("div",{className:l.layerParentText,title:d.name,children:d.name}):(0,c.jsx)("button",{type:"button",className:l.layerItem,disabled:0===f.length,onClick:f.length>0?function(){o(n,e),u.h.event.emit("marker_icon/show",s,{latlng:i,symbology:r(n.layers[e].renderer,f[0].attributes)})}:void 0,children:(0,c.jsxs)("div",{className:l.layerCountTextContainer,children:[(0,c.jsx)("span",{className:l.layerFeatureCount,children:f.length}),(0,c.jsx)("div",{className:l.layerItemText,title:d.name,children:d.name})]})})},t)}))},n.id)}))})};var w=n(6793),j=(0,I.Z)((function(e){return{featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",alignItems:"center",width:"100%"},featureItemIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureItemIcon:{},featureItemText:{display:"inline-block",width:"100%",fontWeight:400,marginLeft:"10px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",fontSize:"16px"}}}));const C=function(e){var t=e.selectedLayer,n=e.selectLayer,a=e.selectFeature,r=e.setPanel,i=e.getSymbol,s=e.buttonPanel,l=t.displayField,o=t.fieldAliases,u=t.layerData,d=t.renderer,f=j(),p=(0,w.$)().t,y=function(e,t){s.panel.addActionButton("back",p("action_back"),'<i class="material-icons">keyboard_backspace</i>',(function(){1===u.length?r(!0,!1,!1):n()})),a({attributes:e,displayField:l,fieldAliases:o,symbol:t,numOfEntries:u.length})};return(0,g.useEffect)((function(){s.panel.addActionButton("back",p("action_back"),'<i class="material-icons">keyboard_backspace</i>',(function(){r(!0,!1,!1)}))}),[]),u.length>0?(0,c.jsx)("div",{className:f.featuresContainer,children:u.map((function(e,t){var n=e.attributes,a=i(d,n),r=n[l].length>0?"".concat(n[l]):"".concat(n.OBJECTID);return(0,c.jsx)("div",{tabIndex:0,onKeyDown:function(e){"Enter"===e.key&&y(n,a)},role:"button",children:(0,c.jsx)("div",{className:f.featureItem,onClick:function(){y(n,a)},role:"button",children:(0,c.jsxs)("div",{className:f.featureIconTextContainer,children:[(0,c.jsx)("div",{className:f.featureItemIconContainer,children:a.imageData?(0,c.jsx)("img",{className:f.featureItemIcon,src:"data:".concat(a.contentType,";base64, ").concat(a.imageData),alt:""}):d.symbol.legendImageUrl?(0,c.jsx)("img",{className:f.featureItemIcon,src:d.symbol.legendImageUrl,alt:""}):(0,c.jsx)("div",{className:f.featureItemIcon})}),(0,c.jsx)("span",{className:f.featureItemText,title:r,children:r})]})})},t)}))}):(0,c.jsx)("div",{className:f.featureItemText,children:p("nothing_found")})};var S=(0,I.Z)((function(e){return{featureInfoContainer:{width:"100%"},featureInfoHeader:{display:"flex",alignItems:"center"},featureInfoHeaderIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureInfoHeaderIcon:{},featureInfoHeaderText:{marginLeft:"10px",width:"100%",fontSize:18},featureInfoItemsContainer:{display:"flex",flexDirection:"column",marginTop:20},featureInfoItem:{display:"flex",flexDirection:"column",margin:"5px 0"},featureInfoItemKey:{fontWeight:"bold",fontSize:16},featureInfoItemValue:{fontSize:16,backgroundColor:"#ddd"}}}));const P=function(e){var t=e.buttonPanel,n=e.selectedFeature,a=e.setPanel,r=n.displayField,i=n.fieldAliases,s=n.attributes,l=n.symbol,o=n.numOfEntries,u=S(),d=(0,w.$)().t;return(0,g.useEffect)((function(){t.panel.addActionButton("back",d("action_back"),'<i class="material-icons">keyboard_backspace</i>',(function(){1===o?a(!0,!1,!1):a(!1,!0,!1)}))}),[]),(0,c.jsxs)("div",{className:u.featureInfoContainer,children:[(0,c.jsxs)("div",{className:u.featureInfoHeader,children:[(0,c.jsx)("div",{className:u.featureInfoHeaderIconContainer,children:l.imageData?(0,c.jsx)("img",{className:u.featureInfoHeaderIcon,src:"data:".concat(l.contentType,";base64, ").concat(l.imageData),alt:""}):l.legendImageUrl?(0,c.jsx)("img",{className:u.featureInfoHeaderIcon,src:l.legendImageUrl,alt:""}):(0,c.jsx)("div",{className:u.featureInfoHeaderIcon})}),(0,c.jsx)("span",{className:u.featureInfoHeaderText,children:s[r].length>0?"".concat(s[r]):"".concat(s.OBJECTID)})]}),(0,c.jsx)("div",{className:u.featureInfoItemsContainer,children:Object.keys(s).map((function(e){var t=i[e],n=s[e];return n.length>0&&"OBJECTID"!==t&&"SHAPE"!==t&&(0,c.jsxs)("div",{className:u.featureInfoItem,tabIndex:0,children:[(0,c.jsx)("span",{className:u.featureInfoItemKey,children:t}),(0,c.jsx)("span",{className:u.featureInfoItemValue,children:n})]},e)}))})]})};function O(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function N(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?O(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var D=(0,I.Z)((function(e){return{mainContainer:{display:"flex",flexDirection:"row"}}}));const E=function(e){var t=e.buttonPanel,n=e.mapId,a=(0,g.useState)({}),r=h()(a,2),i=r[0],s=r[1],l=(0,g.useState)({}),d=h()(l,2),p=d[0],m=d[1],b=(0,g.useState)({}),I=h()(b,2),v=I[0],w=I[1],j=(0,g.useState)(!1),S=h()(j,2),O=S[0],E=S[1],_=(0,g.useState)(!1),A=h()(_,2),F=A[0],T=A[1],L=(0,g.useState)(!1),z=h()(L,2),H=z[0],W=z[1],B=(0,g.useState)(),q=h()(B,2),U=q[0],V=q[1],G=D(),K=u.h.map(n).map,Z=(0,g.useCallback)((function(e,t){var n=null;return e&&e.symbol?n=e.symbol:e&&e.uniqueValueInfos&&e.uniqueValueInfos.length>0&&(n=e.uniqueValueInfos.filter((function(n){return n.value===(t[e.field1]||t[e.field2]||t[e.field3])}))[0].symbol),n}),[]),J=function(){var e=x()(y().mark((function e(t){var n,a;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("".concat(t,"?f=json"));case 2:return n=e.sent,e.next=5,n.json();case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),R=(0,g.useCallback)((function(e,n,a){t.panel.removeActionButton("back"),E(e),T(n),W(a)}),[t.panel]),Y=(0,g.useCallback)((function(){R(!0,!1,!1)}),[R]),M=(0,g.useCallback)((function(e){m(e),R(!1,!0,!1)}),[m,R]),$=(0,g.useCallback)((function(e){w(e),R(!1,!1,!0)}),[w,R]),Q=function(e,t,n,a){var r,i,s=t[e.id].layers;s["".concat(n.id,"-").concat(n.name.replace(/\s+/g,"-").toLowerCase())]={layer:n,groupLayer:a,layerData:[],displayField:n.displayField||n.displayFieldName||"",fieldAliases:(r=n.fields,i={},r&&r.forEach((function(e){var t=e.name,n=e.alias;i[t]=n})),i),renderer:n.drawingInfo&&n.drawingInfo.renderer},t[e.id].layers=s},X=(0,g.useCallback)((function(e,t){var n=i[e].layers;n[t].layerData=[],s((function(t){return N(N({},t),{},o()({},e,N(N({},t[e]),{},{layers:n})))}))}),[i]),ee=(0,g.useCallback)(function(){var e=x()(y().mark((function e(a){var r,l,c,d,p;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],l=y().mark((function e(t){var n,l,c,u,d,p,m,x,b,h,g,I,v;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object.keys(i)[t],l=i[n],c=l.layer,u=l.layers,d=0;case 4:if(!(d<Object.keys(u).length)){e.next=22;break}if(p=Object.keys(u)[d],u[p].groupLayer){e.next=19;break}return X(n,p),m=c._map.getSize(),x=c._map.getBounds(),b={xmin:x.getSouthWest().lng,ymin:x.getSouthWest().lat,xmax:x.getNorthEast().lng,ymax:x.getNorthEast().lat,spatialReference:{wkid:4326}},h="".concat(c.mapService.options.url,"identify?")+"f=json&tolerance=3"+"&mapExtent=".concat(b.xmin,",").concat(b.ymin,",").concat(b.xmax,",").concat(b.ymax)+"&imageDisplay=".concat(m.x,",").concat(m.y,",96")+"&layers=visible:".concat(u[p].layer.id)+"&returnFieldName=true&sr=4326&returnGeometry=true"+"&geometryType=esriGeometryPoint&geometry=".concat(a.lng,",").concat(a.lat),e.next=14,fetch(h);case 14:return g=e.sent,e.next=17,g.json();case 17:(I=e.sent)&&I.results&&I.results.length>0&&(r.push({layer:u[p],entries:I.results}),(v=u[p].layerData).push.apply(v,f()(I.results)),s((function(e){return N(N({},e),{},o()({},n,N(N({},e[n]),{},{layers:u})))})));case 19:d++,e.next=4;break;case 22:case"end":return e.stop()}}),e)})),c=0;case 3:if(!(c<Object.keys(i).length)){e.next=8;break}return e.delegateYield(l(c),"t0",5);case 5:c++,e.next=3;break;case 8:d=null,1===r.length?(M(r[0].layer),r[0]&&(d=Z(r[0].layer.renderer,r[0].entries[0].attributes)),1===r[0].entries.length&&$({attributes:r[0].entries[0].attributes,displayField:r[0].layer.displayField,fieldAliases:r[0].layer.fieldAliases,symbol:Z(r[0].layer.renderer,r[0].entries[0].attributes),numOfEntries:1})):(r.length>0&&(d=Z(r[0].layer.renderer,r[0].entries[0].attributes)),Y()),u.h.event.emit("marker_icon/show",n,{latlng:a,symbology:d}),V(a),t.panel.open(),(p=document.querySelectorAll("[data-id=".concat(t.id,"]"))[0])&&p.querySelectorAll(".cgpv-panel-close")[0].focus();case 15:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[n,t.panel,t.id,i,X,M,Z,$,Y]);return(0,g.useEffect)((function(){var e=u.h.map(n).layers,t={};e.forEach(function(){var e=x()(y().mark((function e(n){var a,r,i,s,l,o,c,u;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t[n.id]={id:n.id,type:n.type,layer:n.layer,layers:{}},"ogcWMS"!==n.type){e.next=17;break}a=n.layer.entries,r=0;case 4:if(!(r<a.length)){e.next=15;break}return i=a[r],e.next=8,J(n.layer.mapService.options.url+i);case 8:s=e.sent,l="".concat(n.layer._url,"?request=GetLegendGraphic&version=1.0.0&Service=WMS&format=image/png&layer=").concat(i),s.drawingInfo&&s.drawingInfo.renderer&&s.drawingInfo.renderer.symbol&&Object.defineProperties(s.drawingInfo.renderer.symbol,{legendImageUrl:{value:l}}),Q(n,t,s,!1);case 12:r++,e.next=4;break;case 15:e.next=25;break;case 17:if("esriFeature"!==n.type){e.next=24;break}return e.next=20,J(n.layer.options.url);case 20:o=e.sent,Q(n,t,o,!1),e.next=25;break;case 24:"esriDynamic"===n.type&&(c=n.layer.getLayers(),u={},c.forEach((function(e){u[e]=e})),n.layer.metadata(function(){var e=x()(y().mark((function e(a,r){var i,s,l,o,c,d;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a){e.next=2;break}return e.abrupt("return");case 2:if(!r.layers){e.next=25;break}i=0;case 4:if(!(i<r.layers.length)){e.next=25;break}if(!((s=r.layers[i]).id in u)){e.next=22;break}return e.next=9,J(n.layer.options.url+s.id);case 9:if(l=e.sent,Q(n,t,l,null!==s.subLayerIds&&void 0!==s.subLayerIds),!s.subLayerIds){e.next=22;break}o=0;case 13:if(!(o<s.subLayerIds.length)){e.next=22;break}return c=s.subLayerIds[o],e.next=17,J(n.layer.options.url+c);case 17:d=e.sent,Q(n,t,d,!1);case 19:o++,e.next=13;break;case 22:i++,e.next=4;break;case 25:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()));case 25:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),s(t)}),[]),(0,g.useEffect)((function(){return K.on("click",function(){var e=x()(y().mark((function e(t){return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:ee(t.latlng);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),u.h.event.on("details_panel/crosshair_enter",(function(e){e.handlerName===n&&ee(e.latlng)}),n),function(){K.off("click"),u.h.event.off("details_panel/crosshair_enter")}}),[ee,n,K]),(0,c.jsxs)("div",{className:G.mainContainer,children:[O&&(0,c.jsx)(k,{clickPos:U,layersData:i,selectFeature:$,selectLayer:M,getSymbol:Z,mapId:n}),F&&(0,c.jsx)(C,{getSymbol:Z,buttonPanel:t,selectLayer:M,selectedLayer:p,selectFeature:$,setPanel:R}),H&&(0,c.jsx)(P,{buttonPanel:t,selectedFeature:v,setPanel:R})]})};const _=function(){function e(){var t=this;r()(this,e),o()(this,"buttonPanel",void 0),o()(this,"translations",{"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found",action_back:"Back"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat",action_back:"Retour"}}),o()(this,"added",(function(){var e=t.props.mapId,n=u.h.map(e).language,a={id:"detailsPanel",tooltip:t.translations[n].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},r={title:t.translations[n].detailsPanel,icon:'<i class="material-icons">details</i>',width:300};t.buttonPanel=u.h.map(e).createAppbarPanel(a,r,null),t.buttonPanel.panel.changeContent((0,c.jsx)(E,{buttonPanel:t.buttonPanel,mapId:e}))}))}return s()(e,[{key:"removed",value:function(){var e=this.props.mapId;u.h.map(e).removeAppbarPanel(this.buttonPanel.id)}}]),e}()}}]);