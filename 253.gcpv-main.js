(self.webpackChunkgeo_view=self.webpackChunkgeo_view||[]).push([[253],{6253:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>A});var a=n(4575),r=n.n(a),i=n(3913),s=n.n(i),l=n(9713),o=n.n(l),c=n(5893),u=n(3137),f=n(319),d=n.n(f),p=n(7757),y=n.n(p),m=n(8926),x=n.n(m),b=n(3038),h=n.n(b),g=n(7294),I=n(1120),v=(0,I.Z)((function(e){return{layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3,border:"none",width:"100%"},layerParentText:{fontSize:"16px",fontWeight:"bold"},layerCountTextContainer:{display:"flex",alignItems:"center",width:"100%"},layerFeatureCount:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)",marginRight:"10px",color:"black",fontSize:"16px",fontWeight:"bold"},layerItemText:{fontSize:"14px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"}}}));const k=function(e){var t=e.layersData,n=e.selectFeature,a=e.selectLayer,r=e.getSymbol,i=v(),s=function(e,t){var i=e.layers[t],s=i.layerData,l=i.displayField,o=i.fieldAliases,c=i.renderer;a(e.layers[t]),1===s.length&&n({attributes:s[0].attributes,displayField:l,fieldAliases:o,symbol:r(c,s[0].attributes),numOfEntries:1})};return(0,c.jsx)("div",{className:i.layersContainer,children:Object.keys(t).map((function(e){var n=t[e];return(0,c.jsx)("div",{children:Object.keys(n.layers).map((function(e,t){var a=n.layers[e],r=a.layer,l=a.layerData,o=a.groupLayer;return(0,c.jsx)("div",{tabIndex:l.length>0&&!o?0:-1,onKeyDown:function(t){"Enter"===t.key&&(o||s(n,e))},role:"button",children:o?(0,c.jsx)("div",{className:i.layerParentText,title:r.name,children:r.name}):(0,c.jsx)("button",{type:"button",className:i.layerItem,disabled:0===l.length,onClick:l.length>0?function(){s(n,e)}:void 0,children:(0,c.jsxs)("div",{className:i.layerCountTextContainer,children:[(0,c.jsx)("span",{className:i.layerFeatureCount,children:l.length}),(0,c.jsx)("div",{className:i.layerItemText,title:r.name,children:r.name})]})})},t)}))},n.id)}))})};var j=n(6793),w=(0,I.Z)((function(e){return{featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",alignItems:"center",width:"100%"},featureItemIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureItemIcon:{},featureItemText:{display:"inline-block",width:"100%",fontWeight:400,marginLeft:"10px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",fontSize:"16px"}}}));const C=function(e){var t=e.selectedLayer,n=e.selectLayer,a=e.selectFeature,r=e.setPanel,i=e.getSymbol,s=e.buttonPanel,l=t.displayField,o=t.fieldAliases,u=t.layerData,f=t.renderer,d=w(),p=(0,j.$)().t,y=function(e,t){s.panel.addActionButton("back",p("action_back"),'<i class="material-icons">keyboard_backspace</i>',(function(){1===u.length?r(!0,!1,!1):n()})),a({attributes:e,displayField:l,fieldAliases:o,symbol:t,numOfEntries:u.length})};return(0,g.useEffect)((function(){s.panel.addActionButton("back",p("action_back"),'<i class="material-icons">keyboard_backspace</i>',(function(){r(!0,!1,!1)}))}),[]),u.length>0?(0,c.jsx)("div",{className:d.featuresContainer,children:u.map((function(e,t){var n=e.attributes,a=i(f,n),r=n[l].length>0?"".concat(n[l]):"".concat(n.OBJECTID);return(0,c.jsx)("div",{tabIndex:0,onKeyDown:function(e){"Enter"===e.key&&y(n,a)},role:"button",children:(0,c.jsx)("div",{className:d.featureItem,onClick:function(){y(n,a)},role:"button",children:(0,c.jsxs)("div",{className:d.featureIconTextContainer,children:[(0,c.jsx)("div",{className:d.featureItemIconContainer,children:a.imageData?(0,c.jsx)("img",{className:d.featureItemIcon,src:"data:".concat(a.contentType,";base64, ").concat(a.imageData),alt:""}):f.symbol.legendImageUrl?(0,c.jsx)("img",{className:d.featureItemIcon,src:f.symbol.legendImageUrl,alt:""}):(0,c.jsx)("div",{className:d.featureItemIcon})}),(0,c.jsx)("span",{className:d.featureItemText,title:r,children:r})]})})},t)}))}):(0,c.jsx)("div",{className:d.featureItemText,children:p("nothing_found")})};var S=(0,I.Z)((function(e){return{featureInfoContainer:{width:"100%"},featureInfoHeader:{display:"flex",alignItems:"center"},featureInfoHeaderIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureInfoHeaderIcon:{},featureInfoHeaderText:{marginLeft:"10px",width:"100%",fontSize:18},featureInfoItemsContainer:{display:"flex",flexDirection:"column",marginTop:20},featureInfoItem:{display:"flex",flexDirection:"column",margin:"5px 0"},featureInfoItemKey:{fontWeight:"bold",fontSize:16},featureInfoItemValue:{fontSize:16,backgroundColor:"#ddd"}}}));const P=function(e){var t=e.buttonPanel,n=e.selectedFeature,a=e.setPanel,r=n.displayField,i=n.fieldAliases,s=n.attributes,l=n.symbol,o=n.numOfEntries,u=S(),f=(0,j.$)().t;return(0,g.useEffect)((function(){t.panel.addActionButton("back",f("action_back"),'<i class="material-icons">keyboard_backspace</i>',(function(){1===o?a(!0,!1,!1):a(!1,!0,!1)}))}),[]),(0,c.jsxs)("div",{className:u.featureInfoContainer,children:[(0,c.jsxs)("div",{className:u.featureInfoHeader,children:[(0,c.jsx)("div",{className:u.featureInfoHeaderIconContainer,children:l.imageData?(0,c.jsx)("img",{className:u.featureInfoHeaderIcon,src:"data:".concat(l.contentType,";base64, ").concat(l.imageData),alt:""}):l.legendImageUrl?(0,c.jsx)("img",{className:u.featureInfoHeaderIcon,src:l.legendImageUrl,alt:""}):(0,c.jsx)("div",{className:u.featureInfoHeaderIcon})}),(0,c.jsx)("span",{className:u.featureInfoHeaderText,children:s[r].length>0?"".concat(s[r]):"".concat(s.OBJECTID)})]}),(0,c.jsx)("div",{className:u.featureInfoItemsContainer,children:Object.keys(s).map((function(e){var t=i[e],n=s[e];return n.length>0&&"OBJECTID"!==t&&"SHAPE"!==t&&(0,c.jsxs)("div",{className:u.featureInfoItem,tabIndex:0,children:[(0,c.jsx)("span",{className:u.featureInfoItemKey,children:t}),(0,c.jsx)("span",{className:u.featureInfoItemValue,children:n})]},e)}))})]})};function O(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function N(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?O(Object(n),!0).forEach((function(t){o()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var D=(0,I.Z)((function(e){return{mainContainer:{display:"flex",flexDirection:"row"}}}));const E=function(e){var t=e.buttonPanel,n=e.mapId,a=(0,g.useState)({}),r=h()(a,2),i=r[0],s=r[1],l=(0,g.useState)({}),f=h()(l,2),p=f[0],m=f[1],b=(0,g.useState)({}),I=h()(b,2),v=I[0],j=I[1],w=(0,g.useState)(!1),S=h()(w,2),O=S[0],E=S[1],A=(0,g.useState)(!1),F=h()(A,2),T=F[0],_=F[1],L=(0,g.useState)(!1),z=h()(L,2),H=z[0],W=z[1],B=D(),q=u.h.map(n).map,U=(0,g.useCallback)((function(e,t){var n=null;return e&&e.symbol?n=e.symbol:e&&e.uniqueValueInfos&&e.uniqueValueInfos.length>0&&(n=e.uniqueValueInfos.filter((function(n){return n.value===(t[e.field1]||t[e.field2]||t[e.field3])}))[0].symbol),n}),[]),V=function(){var e=x()(y().mark((function e(t){var n,a;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("".concat(t,"?f=json"));case 2:return n=e.sent,e.next=5,n.json();case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),G=(0,g.useCallback)((function(e,n,a){t.panel.removeActionButton("back"),E(e),_(n),W(a)}),[t.panel]),K=(0,g.useCallback)((function(){G(!0,!1,!1)}),[G]),Z=(0,g.useCallback)((function(e){m(e),G(!1,!0,!1)}),[m,G]),J=(0,g.useCallback)((function(e){j(e),G(!1,!1,!0)}),[j,G]),R=function(e,t,n,a){var r,i,s=t[e.id].layers;s["".concat(n.id,"-").concat(n.name.replace(/\s+/g,"-").toLowerCase())]={layer:n,groupLayer:a,layerData:[],displayField:n.displayField||n.displayFieldName||"",fieldAliases:(r=n.fields,i={},r&&r.forEach((function(e){var t=e.name,n=e.alias;i[t]=n})),i),renderer:n.drawingInfo&&n.drawingInfo.renderer},t[e.id].layers=s},Y=(0,g.useCallback)((function(e,t){var n=i[e].layers;n[t].layerData=[],s((function(t){return N(N({},t),{},o()({},e,N(N({},t[e]),{},{layers:n})))}))}),[i]),M=(0,g.useCallback)(function(){var e=x()(y().mark((function e(n){var a,r,l,c;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],r=y().mark((function e(t){var r,l,c,u,f,p,m,x,b,h,g,I,v;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=Object.keys(i)[t],l=i[r],c=l.layer,u=l.layers,f=0;case 4:if(!(f<Object.keys(u).length)){e.next=22;break}if(p=Object.keys(u)[f],u[p].groupLayer){e.next=19;break}return Y(r,p),m=c._map.getSize(),x=c._map.getBounds(),b={xmin:x.getSouthWest().lng,ymin:x.getSouthWest().lat,xmax:x.getNorthEast().lng,ymax:x.getNorthEast().lat,spatialReference:{wkid:4326}},h="".concat(c.mapService.options.url,"identify?")+"f=json&tolerance=3"+"&mapExtent=".concat(b.xmin,",").concat(b.ymin,",").concat(b.xmax,",").concat(b.ymax)+"&imageDisplay=".concat(m.x,",").concat(m.y,",96")+"&layers=visible:".concat(u[p].layer.id)+"&returnFieldName=true&sr=4326&returnGeometry=true"+"&geometryType=esriGeometryPoint&geometry=".concat(n.lng,",").concat(n.lat),e.next=14,fetch(h);case 14:return g=e.sent,e.next=17,g.json();case 17:(I=e.sent)&&I.results&&I.results.length>0&&(a.push({layer:u[p],entries:I.results}),(v=u[p].layerData).push.apply(v,d()(I.results)),s((function(e){return N(N({},e),{},o()({},r,N(N({},e[r]),{},{layers:u})))})));case 19:f++,e.next=4;break;case 22:case"end":return e.stop()}}),e)})),l=0;case 3:if(!(l<Object.keys(i).length)){e.next=8;break}return e.delegateYield(r(l),"t0",5);case 5:l++,e.next=3;break;case 8:1===a.length?(Z(a[0].layer),1===a[0].entries.length&&J({attributes:a[0].entries[0].attributes,displayField:a[0].layer.displayField,fieldAliases:a[0].layer.fieldAliases,symbol:U(a[0].layer.renderer,a[0].entries[0].attributes),numOfEntries:1})):K(),t.panel.open(),(c=document.querySelectorAll("[data-id=".concat(t.id,"]"))[0])&&c.querySelectorAll(".cgpv-panel-close")[0].focus();case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[t.panel,t.id,i,Y,Z,J,U,K]);return(0,g.useEffect)((function(){var e=u.h.map(n).layers,t={};e.forEach(function(){var e=x()(y().mark((function e(n){var a,r,i,s,l,o,c,u;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t[n.id]={id:n.id,type:n.type,layer:n.layer,layers:{}},"ogcWMS"!==n.type){e.next=17;break}a=n.layer.entries,r=0;case 4:if(!(r<a.length)){e.next=15;break}return i=a[r],e.next=8,V(n.layer.mapService.options.url+i);case 8:s=e.sent,l="".concat(n.layer._url,"?request=GetLegendGraphic&version=1.0.0&Service=WMS&format=image/png&layer=").concat(i),s.drawingInfo&&s.drawingInfo.renderer&&s.drawingInfo.renderer.symbol&&Object.defineProperties(s.drawingInfo.renderer.symbol,{legendImageUrl:{value:l}}),R(n,t,s,!1);case 12:r++,e.next=4;break;case 15:e.next=25;break;case 17:if("esriFeature"!==n.type){e.next=24;break}return e.next=20,V(n.layer.options.url);case 20:o=e.sent,R(n,t,o,!1),e.next=25;break;case 24:"esriDynamic"===n.type&&(c=n.layer.getLayers(),u={},c.forEach((function(e){u[e]=e})),n.layer.metadata(function(){var e=x()(y().mark((function e(a,r){var i,s,l,o,c,f;return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a){e.next=2;break}return e.abrupt("return");case 2:if(!r.layers){e.next=25;break}i=0;case 4:if(!(i<r.layers.length)){e.next=25;break}if(!((s=r.layers[i]).id in u)){e.next=22;break}return e.next=9,V(n.layer.options.url+s.id);case 9:if(l=e.sent,R(n,t,l,null!==s.subLayerIds&&void 0!==s.subLayerIds),!s.subLayerIds){e.next=22;break}o=0;case 13:if(!(o<s.subLayerIds.length)){e.next=22;break}return c=s.subLayerIds[o],e.next=17,V(n.layer.options.url+c);case 17:f=e.sent,R(n,t,f,!1);case 19:o++,e.next=13;break;case 22:i++,e.next=4;break;case 25:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()));case 25:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),s(t)}),[]),(0,g.useEffect)((function(){return q.on("click",function(){var e=x()(y().mark((function e(t){return y().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:M(t.latlng);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),u.h.event.on("details_panel/crosshair_enter",(function(e){e.handlerName===n&&M(e.latlng)}),n),function(){q.off("click"),u.h.event.off("details_panel/crosshair_enter")}}),[M,n,q]),(0,c.jsxs)("div",{className:B.mainContainer,children:[O&&(0,c.jsx)(k,{layersData:i,selectFeature:J,selectLayer:Z,getSymbol:U}),T&&(0,c.jsx)(C,{getSymbol:U,buttonPanel:t,selectLayer:Z,selectedLayer:p,selectFeature:J,setPanel:G}),H&&(0,c.jsx)(P,{buttonPanel:t,selectedFeature:v,setPanel:G})]})};const A=function(){function e(){var t=this;r()(this,e),o()(this,"buttonPanel",void 0),o()(this,"translations",{"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found",action_back:"Back"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat",action_back:"Retour"}}),o()(this,"added",(function(){var e=t.props.mapId,n=u.h.map(e).language,a={id:"detailsPanel",tooltip:t.translations[n].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},r={title:t.translations[n].detailsPanel,icon:'<i class="material-icons">details</i>',width:300};t.buttonPanel=u.h.map(e).createAppbarPanel(a,r,null),t.buttonPanel.panel.changeContent((0,c.jsx)(E,{buttonPanel:t.buttonPanel,mapId:e}))}))}return s()(e,[{key:"removed",value:function(){var e=this.props.mapId;u.h.map(e).removeAppbarPanel(this.buttonPanel.id)}}]),e}()}}]);