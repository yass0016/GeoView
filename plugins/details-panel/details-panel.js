window.plugins=window.plugins||{},window.plugins.detailsPanel=class{buttonPanel=null;translations={"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found",action_back:"Back",activate_crosshair:"Activate Crosshair"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat",action_back:"Retour",activate_crosshair:"Activer le réticule"}};added=()=>{const{api:e,react:a,makeStyles:t,translate:n}=this,{mapId:r}=this.props,l=this.createElement,{useState:s,useEffect:i,useCallback:o}=a,{useTranslation:c}=n,{language:d}=e.map(r),u=t((e=>({mainContainer:{display:"flex",flexDirection:"row"},layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3,border:"none",width:"100%"},layerParentText:{fontSize:"16px",fontWeight:"bold"},layerCountTextContainer:{display:"flex",alignItems:"center",width:"100%"},layerFeatureCount:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)",marginRight:"10px",color:"black",fontSize:"16px",fontWeight:"bold"},layerItemText:{fontSize:"14px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",alignItems:"center",width:"100%"},featureItemIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureItemIcon:{},featureItemText:{display:"inline-block",width:"100%",fontWeight:"400",marginLeft:"10px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",fontSize:"16px"},featureInfoContainer:{width:"100%"},featureInfoHeader:{display:"flex",alignItems:"center"},featureInfoHeaderIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureInfoHeaderIcon:{},featureInfoHeaderText:{marginLeft:"10px",width:"100%",fontSize:18},featureInfoItemsContainer:{display:"flex",flexDirection:"column",marginTop:20},featureInfoItem:{display:"flex",flexDirection:"column",margin:"5px 0"},featureInfoItemKey:{fontWeight:"bold",fontSize:16},featureInfoItemValue:{fontSize:16,backgroundColor:"#ddd"}}))),f=(e,a)=>{let t=null;return e&&e.symbol?t=e.symbol:e&&e.uniqueValueInfos&&e.uniqueValueInfos.length>0&&(t=e.uniqueValueInfos.filter((t=>t.value===(a[e.field1]||a[e.field2]||a[e.field3])))[0].symbol),t},y=e=>{const a=u(),t=(a,t)=>{const{layerData:n,displayField:r,fieldAliases:l,renderer:s}=a.layers[t];e.selectLayer(a.layers[t]),1===n.length&&e.selectFeature({attributes:n[0].attributes,displayField:r,fieldAliases:l,symbol:f(s,n[0].attributes),numOfEntries:1})};return l("div",{className:a.layersContainer},Object.keys(e.layersData).map((n=>{const r=e.layersData[n];return l("div",{key:r.id},Object.keys(r.layers).map(((e,n)=>{const{layer:s,layerData:i,groupLayer:o}=r.layers[e];return l("div",{key:n,tabIndex:i.length>0&&!o?0:-1,onKeyDown:a=>{"Enter"===a.key&&(o||t(r,e))}},o?l("div",{className:a.layerParentText,title:s.name},s.name):l("button",{className:a.layerItem,disabled:0===i.length,onClick:i.length>0?a=>{t(r,e)}:null},l("div",{className:a.layerCountTextContainer},l("span",{className:a.layerFeatureCount},i.length),l("div",{className:a.layerItemText,title:s.name},s.name))))})))})))},m=e=>{const{displayField:a,fieldAliases:t,layerData:n,renderer:r}=e.selectedLayer,s=u(),{t:o}=c(),d=(r,l)=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{1===n.length?e.setPanel(!0,!1,!1):e.selectLayer()})),e.selectFeature({attributes:r,displayField:a,fieldAliases:t,symbol:l,numOfEntries:n.length})};return i((()=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{e.setPanel(!0,!1,!1)}))}),[]),n.length>0?l("div",{className:s.featuresContainer},n.map(((e,t)=>{const{attributes:n}=e,i=f(r,n),o=n[a].length>0?`${n[a]}`:`${n.OBJECTID}`;return l("div",{key:t,tabIndex:0,onKeyDown:e=>{"Enter"===e.key&&d(n,i)}},l("div",{className:s.featureItem,onClick:e=>{d(n,i)}},l("div",{className:s.featureIconTextContainer},l("div",{className:s.featureItemIconContainer},i.imageData?l("img",{className:s.featureItemIcon,src:`data:${i.contentType};base64, ${i.imageData}`}):r.symbol.legendImageUrl?l("img",{className:s.featureItemIcon,src:r.symbol.legendImageUrl}):l("div",{className:s.featureItemIcon})),l("span",{className:s.featureItemText,title:o},o))))}))):l("div",{className:s.featureItemText},o("nothing_found"))},p=e=>{const{displayField:a,fieldAliases:t,attributes:n,symbol:r,numOfEntries:s}=e.selectedFeature,o=u(),{t:d}=c();return i((()=>{this.buttonPanel.panel.addActionButton("back",d("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{1===s?e.setPanel(!0,!1,!1):e.setPanel(!1,!0,!1)}))}),[]),l("div",{className:o.featureInfoContainer},l("div",{className:o.featureInfoHeader},l("div",{className:o.featureInfoHeaderIconContainer},r.imageData?l("img",{className:o.featureInfoHeaderIcon,src:`data:${r.contentType};base64, ${r.imageData}`}):r.legendImageUrl?l("img",{className:o.featureInfoHeaderIcon,src:r.legendImageUrl}):l("div",{className:o.featureInfoHeaderIcon})),l("span",{className:o.featureInfoHeaderText},n[a].length>0?`${n[a]}`:`${n.OBJECTID}`)),l("div",{className:o.featureInfoItemsContainer},Object.keys(n).map((e=>{const a=t[e],r=n[e];return r.length>0&&"OBJECTID"!==a&&"SHAPE"!==a&&l("div",{className:o.featureInfoItem,key:e,tabIndex:0},l("span",{className:o.featureInfoItemKey},a),l("span",{className:o.featureInfoItemValue},r))}))))},g={id:"detailsPanel",tooltip:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},b={title:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',content:()=>{const[a,t]=s({}),[n,d]=s({}),[g,b]=s({}),[x,I]=s(!1),[h,w]=s(!1),[v,k]=s(!1),C=u(),{t:N}=c(),P=e.map(r).map,S=async e=>{const a=await fetch(`${e}?f=json`);return await a.json()},D=(e,a,t)=>{this.buttonPanel.panel.removeActionButton("back"),I(e),w(a),k(t)},$=o((()=>{D(!0,!1,!1)}),[]),A=o((e=>{d(e),D(!1,!0,!1)}),[d]),T=o((e=>{b(e),D(!1,!1,!0)}),[b]),F=e=>{const a={};return e&&e.forEach((e=>{const{name:t,alias:n}=e;a[t]=n})),a},_=(e,a,t,n)=>{const{layers:r}=a[e.id];r[`${t.id}-${t.name.replace(/\s+/g,"-").toLowerCase()}`]={layer:t,groupLayer:n,layerData:[],displayField:t.displayField||t.displayFieldName||"",fieldAliases:F(t.fields),renderer:t.drawingInfo&&t.drawingInfo.renderer},a[e.id].layers=r},E=o(((e,n)=>{const r=a[e],{layers:l}=r;l[n].layerData=[],t((a=>({...a,[e]:{...a[e],layers:l}})))}),[a]),L=o((async e=>{const n=[];for(let r=0;r<Object.keys(a).length;r++){const l=Object.keys(a)[r],s=a[l],{layer:i,layers:o}=s;for(let a=0;a<Object.keys(o).length;a++){const r=Object.keys(o)[a];if(!o[r].groupLayer){E(l,r);const a=i._map.getSize(),s=i._map.getBounds(),c={xmin:s.getSouthWest().lng,ymin:s.getSouthWest().lat,xmax:s.getNorthEast().lng,ymax:s.getNorthEast().lat,spatialReference:{wkid:4326}},d=`${i.mapService.options.url}identify?f=json&tolerance=3&mapExtent=${c.xmin},${c.ymin},${c.xmax},${c.ymax}&imageDisplay=${a.x},${a.y},96&layers=visible:${o[r].layer.id}&returnFieldName=true&sr=4326&returnGeometry=true&geometryType=esriGeometryPoint&geometry=${e.lng},${e.lat}`,u=await fetch(d),f=await u.json();f&&f.results&&f.results.length>0&&(n.push({layer:o[r],entries:f.results}),o[r].layerData.push(...f.results),t((e=>({...e,[l]:{...e[l],layers:o}}))))}}}1===n.length?(A(n[0].layer),1===n[0].entries.length&&T({attributes:n[0].entries[0].attributes,displayField:n[0].layer.displayField,fieldAliases:n[0].layer.fieldAliases,symbol:f(n[0].layer.renderer,n[0].entries[0].attributes),numOfEntries:1})):$(),this.buttonPanel.panel.open();const r=document.querySelectorAll(`[data-id=${this.buttonPanel.id}]`)[0];r&&r.querySelectorAll(".cgpv-panel-close")[0].focus()}),[T,A,$,E,a]);return i((()=>{const a=e.map(r).layers,n={};a.forEach((async e=>{if(n[e.id]={id:e.id,type:e.type,layer:e.layer,layers:{}},"ogcWMS"===e.type){const a=await S(e.layer.mapService.options.url+0),t=`${e.layer._url}?request=GetLegendGraphic&version=1.0.0&Service=WMS&format=image/png&layer=0`;a.drawingInfo&&a.drawingInfo.renderer&&a.drawingInfo.renderer.symbol&&Object.defineProperties(a.drawingInfo.renderer.symbol,{legendImageUrl:{value:t}}),_(e,n,a,!1)}else if("esriFeature"===e.type){const a=await S(e.layer.options.url);_(e,n,a,!1)}else if("esriDynamic"===e.type){const a=e.layer.getLayers(),t={};a.forEach((e=>{t[e]=e})),e.layer.metadata((async(a,r)=>{if(!a&&r.layers)for(let a=0;a<r.layers.length;a++){const l=r.layers[a];if(l.id in t){const a=await S(e.layer.options.url+l.id);if(_(e,n,a,null!==l.subLayerIds&&void 0!==l.subLayerIds),l.subLayerIds)for(let a=0;a<l.subLayerIds.length;a++){const t=l.subLayerIds[a],r=await S(e.layer.options.url+t);_(e,n,r,!1)}}}}))}})),t(n)}),[]),i((()=>(P.on("click",(async e=>{L(e.latlng)})),e.event.on("details_panel/crosshair_enter",(function(e){e.handlerName===r&&L(e.latlng)}),r),()=>{P.off("click"),e.event.off("details_panel/crosshair_enter")})),[L,P]),l("div",{className:C.mainContainer},x&&l(y,{layersData:a,selectFeature:T,selectLayer:A}),h&&l(m,{selectedLayer:n,selectFeature:T,setPanel:D}),v&&l(p,{selectedFeature:g,setPanel:D}))},width:300};this.buttonPanel=e.map(r).createAppbarPanel(g,b,null)};removed=()=>{const{mapId:e}=this.props;this.api.map(e).removeAppbarPanel(this.buttonPanel.id)}};