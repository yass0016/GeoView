window.plugins=window.plugins||{},window.plugins.detailsPanel=class{buttonPanel=null;translations={"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found",action_back:"Back"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat",action_back:"Retour"}};added=()=>{const{api:e,react:a,makeStyles:t,translate:n}=this,{mapId:i}=this.props,s=this.createElement,{useState:l,useEffect:r,useCallback:o}=a,{useTranslation:c}=n,{language:d}=e.map(i),p=t((e=>({mainContainer:{display:"flex",flexDirection:"row"},layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},layerParentText:{fontSize:"16px",fontWeight:"bold"},layerCountTextContainer:{display:"flex",alignItems:"center",width:"100%"},layerFeatureCount:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)",marginRight:"10px",color:"black",fontSize:"16px",fontWeight:"bold"},layerItemText:{fontSize:"14px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",alignItems:"center",width:"100%"},featureItemIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureItemIcon:{},featureItemText:{display:"inline-block",width:"100%",fontWeight:"400",marginLeft:"10px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",fontSize:"16px"},featureInfoContainer:{},featureInfoHeader:{display:"flex",alignItems:"center"},featureInfoHeaderIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureInfoHeaderIcon:{},featureInfoHeaderText:{marginLeft:"10px",width:"100%",fontSize:18},featureInfoItemsContainer:{display:"flex",flexDirection:"column",marginTop:20},featureInfoItem:{display:"flex",flexDirection:"column",margin:"5px 0"},featureInfoItemKey:{fontWeight:"bold",fontSize:16},featureInfoItemValue:{fontSize:16}}))),u=e=>{const a=p(),{t}=c();return s("div",{className:a.layersContainer},Object.keys(e.layersData).map((t=>{const n=e.layersData[t];return s("div",{key:n.id},Object.keys(n.layers).map(((t,i)=>{const{layer:l,layerData:r,groupLayer:o}=n.layers[t];return s("div",{key:i},o?s("div",{className:a.layerParentText,title:l.name},l.name):s("div",{className:a.layerItem,onClick:a=>{e.selectLayer(n.layers[t])}},s("div",{className:a.layerCountTextContainer},s("span",{className:a.layerFeatureCount},r.length),s("div",{className:a.layerItemText,title:l.name},l.name))))})))})))},f=e=>{const{displayField:a,fieldAliases:t,layerData:n,renderer:i}=e.selectedLayer,l=p(),{t:o}=c();return r((()=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{e.setPanel(!0,!1,!1)}))}),[]),n.length>0?s("div",{className:l.featuresContainer},n.map(((n,r)=>{const{attributes:c}=n;let d=null;i&&i.symbol?d=i.symbol:i&&i.uniqueValueInfos&&i.uniqueValueInfos.length>0&&(d=i.uniqueValueInfos.filter((e=>e.value===(c[i.field1]||c[i.field2]||c[i.field3])))[0].symbol);const p=c[a].length>0?`${c[a]}`:`${c.OBJECTID}`;return s("div",{key:r,tabIndex:"-1"},s("div",{className:l.featureItem,onClick:n=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{e.selectLayer()})),e.selectFeature({attributes:c,displayField:a,fieldAliases:t,symbol:d})}},s("div",{className:l.featureIconTextContainer},s("div",{className:l.featureItemIconContainer},d.imageData?s("img",{className:l.featureItemIcon,src:`data:${d.contentType};base64, ${d.imageData}`}):s("div",{className:l.featureItemIcon})),s("span",{className:l.featureItemText,title:p},p))))}))):s("div",{className:l.featureItemText},o("nothing_found"))},m=e=>{const{displayField:a,fieldAliases:t,attributes:n,symbol:i}=e.selectedFeature,l=p(),{t:o}=c();return r((()=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{e.setPanel(!1,!0,!1)}))}),[]),s("div",{className:l.featureInfoContainer},s("div",{className:l.featureInfoHeader},s("div",{className:l.featureInfoHeaderIconContainer},i.imageData?s("img",{className:l.featureInfoHeaderIcon,src:`data:${i.contentType};base64, ${i.imageData}`}):s("div",{className:l.featureInfoHeaderIcon})),s("span",{className:l.featureInfoHeaderText},n[a].length>0?`${n[a]}`:`${n.OBJECTID}`)),s("div",{className:l.featureInfoItemsContainer},Object.keys(n).map((e=>{const a=t[e],i=n[e];return i.length>0&&"OBJECTID"!==a&&"SHAPE"!==a&&s("div",{className:l.featureInfoItem,key:e},s("span",{className:l.featureInfoItemKey},a),s("span",{className:l.featureInfoItemValue},i))}))))},y={tooltip:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},x={title:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',content:()=>{const[a,t]=l({}),[n,c]=l({}),[d,y]=l({}),[x,g]=l(!0),[I,b]=l(!1),[h,w]=l(!1),v=p(),C=e.map(i).map,k=async e=>{const a=await fetch(`${e}?f=json`);return await a.json()},N=(e,a,t)=>{this.buttonPanel.panel.removeActionButton("back"),g(e),b(a),w(t)},P=o((()=>{N(!0,!1,!1)}),[]),S=o((e=>{N(!1,!0,!1),c(e)}),[c]),D=o((e=>{N(!1,!1,!0),y(e)}),[y]),T=e=>{const a={};return e&&e.forEach((e=>{const{name:t,alias:n}=e;a[t]=n})),a},$=(e,a,t,n)=>{const{layers:i}=a[e.id];i[`${t.id}-${t.name.replace(/\s+/g,"-").toLowerCase()}`]={layer:t,groupLayer:n,layerData:[],displayField:t.displayField||t.displayFieldName||"",fieldAliases:T(t.fields),renderer:t.drawingInfo&&t.drawingInfo.renderer},a[e.id].layers=i},L=o(((e,n)=>{const i=a[e],{layers:s}=i;s[n].layerData=[],t((a=>({...a,[e]:{...a[e],layers:s}})))}),[a]);return r((()=>{const a=e.map(i).layers,n={};a.forEach((async e=>{if(n[e.id]={id:e.id,type:e.type,layer:e.layer,layers:{}},"ogcWMS"===e.type){const a=await k(e.layer.mapService.options.url+0);$(e,n,a,!1)}else if("esriFeature"===e.type){const a=await k(e.layer.options.url);$(e,n,a,!1)}else if("esriDynamic"===e.type){const a=e.layer.getLayers(),t={};a.forEach((e=>{t[e]=e})),e.layer.metadata((async(a,i)=>{if(!a&&i.layers)for(let a=0;a<i.layers.length;a++){const s=i.layers[a];if(s.id in t){const a=await k(e.layer.options.url+s.id);if($(e,n,a,null!==s.subLayerIds&&void 0!==s.subLayerIds),s.subLayerIds)for(let a=0;a<s.subLayerIds.length;a++){const t=s.subLayerIds[a],i=await k(e.layer.options.url+t);$(e,n,i,!1)}}}}))}})),t(n)}),[]),r((()=>(C.on("click",(e=>{Object.keys(a).forEach((n=>{const i=a[n],{layer:s,layers:l}=i;Object.keys(l).forEach((async a=>{if(!l[a].groupLayer){L(n,a);const i=s._map.getSize(),r=s._map.getBounds(),o={xmin:r.getSouthWest().lng,ymin:r.getSouthWest().lat,xmax:r.getNorthEast().lng,ymax:r.getNorthEast().lat,spatialReference:{wkid:4326}},c=`${s.mapService.options.url}identify?f=json&tolerance=3&mapExtent=${o.xmin},${o.ymin},${o.xmax},${o.ymax}&imageDisplay=${i.x},${i.y},96&layers=visible:${l[a].layer.id}&returnFieldName=true&sr=4326&returnGeometry=true&geometryType=esriGeometryPoint&geometry=${e.latlng.lng},${e.latlng.lat}`,d=await fetch(c),p=await d.json();p&&p.results&&p.results.length>0&&(l[a].layerData.push(...p.results),t((e=>({...e,[n]:{...e[n],layers:l}}))))}}))})),P(),this.buttonPanel.panel.open()})),()=>{C.off("click")})),[P,L,a,C]),s("div",{className:v.mainContainer},x&&s(u,{layersData:a,selectLayer:S}),I&&s(f,{selectedLayer:n,selectFeature:D,setPanel:N}),h&&s(m,{selectedFeature:d,setPanel:N}))},width:300};this.buttonPanel=e.map(i).createAppbarPanel(y,x,null)};removed=()=>{const{mapId:e}=this.props;this.api.map(e).removeAppbarPanel(this.buttonPanel.id)}};