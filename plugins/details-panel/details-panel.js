window.plugins=window.plugins||{},window.plugins.detailsPanel=class{buttonPanel=null;translations={"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat"}};added=()=>{const{api:e,react:a,makeStyles:t,translate:n}=this,{mapId:s}=this.props,l=this.createElement,{useState:r,useEffect:i,useCallback:o}=a,{useTranslation:c}=n,{language:d}=e.map(s),y=t((e=>({mainContainer:{display:"flex",flexDirection:"row"},layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},layerCountTextContainer:{display:"flex",justifyContent:"space-around",alignItems:"center"},layerFeatureCount:{padding:"2px 8px",borderRadius:"50%",backgroundColor:"yellow",color:"black",marginRight:"10px"},layerItemText:{fontSize:"16px",fontWeight:"bold"},featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",justifyContent:"space-around",alignItems:"center"},featureItemIcon:{padding:"2px 2px",width:"30px",height:"30px",borderRadius:"50%",backgroundColor:"transparent",color:"black",marginRight:"10px"},featureItemText:{fontSize:"16px",fontWeight:"bold"}}))),p=e=>{const a=y(),{t}=c();return l("div",{className:a.layersContainer},Object.keys(e.layersData).map((t=>{const n=e.layersData[t];return l("div",{key:n.id},Object.keys(n.layers).map(((t,s)=>{const{layer:r,layerData:i}=n.layers[t];return l("div",{key:s},l("div",{className:a.layerItem,onClick:function(a){e.selectLayer(n.layers[t])}},l("div",{className:a.layerCountTextContainer},l("span",{className:a.layerFeatureCount},i.length),l("div",{className:a.layerItemText,title:r.name},r.name))))})))})))},u=e=>{const{displayField:a,fieldAliases:t,layerData:n}=e.selectedLayer,s=y(),{t:r}=c();return console.log(e.selectedLayer.symbol.contentType),n.length>0?l("div",{className:s.featuresContainer},n.map(((t,n)=>{const{attributes:r}=t;return l("div",{key:n},l("div",{className:s.featureItem,onClick:e=>{}},l("div",{className:s.featureIconTextContainer},l("img",{className:s.featureItemIcon,src:`data:${e.selectedLayer.symbol.contentType};base64, ${e.selectedLayer.symbol.imageData}`}),l("div",{className:s.featureItemText},r[a].length>0?`${r[a]}`:`${r.OBJECTID}`))))}))):l("div",{className:s.featuresContainer},r("nothing_found"))},m={tooltip:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},f={title:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',content:()=>{const[a,t]=r({}),[n,c]=r({}),[d,m]=r(!0),[f,g]=r(!1),[h,x]=r(!1),b=y(),C=e.map(s).map,w=async e=>{const a=await fetch(`${e}?f=json`);return await a.json()},I=(e,a,t)=>{m(e),g(a),x(t)},v=o((()=>{I(!0,!1,!1)}),[]),k=o((e=>{I(!1,!0,!1),c(e)}),[c]),N=o((e=>{I(!1,!1,!0)}),[]),$=e=>{const a={};return e&&e.forEach((e=>{const{name:t,alias:n}=e;a[t]=n})),a},D=(e,a,t)=>{const{layers:n}=a[e.id];n[`${t.id}-${t.name.replace(/\s+/g,"-").toLowerCase()}`]={layer:t,layerData:[],displayField:t.displayField||t.displayFieldName||"",fieldAliases:$(t.fields),symbol:t.drawingInfo&&t.drawingInfo.renderer&&t.drawingInfo.renderer.symbol},a[e.id].layers=n},P=o(((e,n)=>{const s=a[e],{layers:l}=s;l[n].layerData=[],t((a=>({...a,[e]:{...a[e],layers:l}})))}),[a]);return i((()=>{const a=e.map(s).layers,n={};a.forEach((async e=>{if(n[e.id]={id:e.id,type:e.type,layer:e.layer,layers:{}},"ogcWMS"===e.type){const a=await w(e.layer.mapService.options.url+0);D(e,n,a)}else if("esriFeature"===e.type){const a=await w(e.layer.options.url);D(e,n,a)}else"esriDynamic"===e.type&&e.layer.metadata(((a,t)=>{a||t.layers&&t.layers.forEach((async a=>{const t=await w(e.layer.options.url+a.id);D(e,n,t)}))}))})),t(n)}),[]),i((()=>(C.on("click",(e=>{Object.keys(a).forEach((n=>{const s=a[n],{layer:l,layers:r}=s;Object.keys(r).forEach((async a=>{P(n,a);const s=l._map.getSize(),i=l._map.getBounds(),o=i.getSouthWest().lng,c=i.getSouthWest().lat,d=i.getNorthEast().lng,y=i.getNorthEast().lat,p=`${l.mapService.options.url}identify?f=json&tolerance=3&mapExtent=${o},${c},${d},${y}&imageDisplay=${s.x},${s.y},96&layers=visible:${r[a].layer.id}&returnFieldName=true&sr=4326&returnGeometry=true&geometryType=esriGeometryPoint&geometry=${e.latlng.lng},${e.latlng.lat}`,u=await fetch(p),m=await u.json();m&&m.results&&m.results.length>0&&(r[a].layerData.push(...m.results),t((e=>({...e,[n]:{...e[n],layers:r}}))))}))})),v(),this.buttonPanel.panel.open()})),()=>{C.off("click")})),[v,P,a,C]),l("div",{className:b.mainContainer},d&&l(p,{layersData:a,selectLayer:k}),f&&l(u,{selectedLayer:n,selectFeature:N}),h&&l("div",{},"Feature Info Panel"))},width:300};this.buttonPanel=e.map(s).createAppbarPanel(m,f,null)};removed=()=>{const{mapId:e}=this.props;this.api.map(e).removeAppbarPanel(this.buttonPanel.id)}};