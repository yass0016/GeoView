window.plugins=window.plugins||{},window.plugins.detailsPanel=class{buttonPanel=null;translations={"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found",action_back:"Back"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat",action_back:"Retour"}};added=()=>{const{api:e,react:t,makeStyles:a,translate:n}=this,{mapId:s}=this.props,i=this.createElement,{useState:l,useEffect:r,useCallback:o}=t,{useTranslation:c}=n,{language:d}=e.map(s),u=a((e=>({mainContainer:{display:"flex",flexDirection:"row"},layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},layerParentText:{fontSize:"16px",fontWeight:"bold"},layerCountTextContainer:{display:"flex",alignItems:"center",width:"100%"},layerFeatureCount:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)",marginRight:"10px",color:"black",fontSize:"16px",fontWeight:"bold"},layerItemText:{fontSize:"14px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",alignItems:"center",width:"100%"},featureItemIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureItemIcon:{},featureItemText:{display:"inline-block",width:"100%",fontWeight:"400",marginLeft:"10px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",fontSize:"16px"},featureInfoContainer:{},featureInfoHeader:{display:"flex",alignItems:"center"},featureInfoHeaderIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureInfoHeaderIcon:{},featureInfoHeaderText:{marginLeft:"10px",width:"100%",fontSize:18},featureInfoItemsContainer:{display:"flex",flexDirection:"column",marginTop:20},featureInfoItem:{display:"flex",flexDirection:"column",margin:"5px 0"},featureInfoItemKey:{fontWeight:"bold",fontSize:16},featureInfoItemValue:{fontSize:16,backgroundColor:"#ddd"}}))),p=(e,t)=>{let a=null;return e&&e.symbol?a=e.symbol:e&&e.uniqueValueInfos&&e.uniqueValueInfos.length>0&&(a=e.uniqueValueInfos.filter((a=>a.value===(t[e.field1]||t[e.field2]||t[e.field3])))[0].symbol),a},f=e=>{const t=u();return i("div",{className:t.layersContainer},Object.keys(e.layersData).map((a=>{const n=e.layersData[a];return i("div",{key:n.id},Object.keys(n.layers).map(((a,s)=>{const{layer:l,layerData:r,groupLayer:o,displayField:c,fieldAliases:d,renderer:u}=n.layers[a];return i("div",{key:s},o?i("div",{className:t.layerParentText,title:l.name},l.name):i("div",{className:t.layerItem,onClick:r.length>0?t=>{e.selectLayer(n.layers[a]),1===r.length&&e.selectFeature({attributes:r[0].attributes,displayField:c,fieldAliases:d,symbol:p(u,r[0].attributes),numOfEntries:1})}:null},i("div",{className:t.layerCountTextContainer},i("span",{className:t.layerFeatureCount},r.length),i("div",{className:t.layerItemText,title:l.name},l.name))))})))})))},y=e=>{const{displayField:t,fieldAliases:a,layerData:n,renderer:s}=e.selectedLayer,l=u(),{t:o}=c();return r((()=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{e.setPanel(!0,!1,!1)}))}),[]),n.length>0?i("div",{className:l.featuresContainer},n.map(((r,c)=>{const{attributes:d}=r,u=p(s,d),f=d[t].length>0?`${d[t]}`:`${d.OBJECTID}`;return i("div",{key:c,tabIndex:"-1"},i("div",{className:l.featureItem,onClick:s=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{1===n.length?e.setPanel(!0,!1,!1):e.selectLayer()})),e.selectFeature({attributes:d,displayField:t,fieldAliases:a,symbol:u,numOfEntries:n.length})}},i("div",{className:l.featureIconTextContainer},i("div",{className:l.featureItemIconContainer},u.imageData?i("img",{className:l.featureItemIcon,src:`data:${u.contentType};base64, ${u.imageData}`}):i("div",{className:l.featureItemIcon})),i("span",{className:l.featureItemText,title:f},f))))}))):i("div",{className:l.featureItemText},o("nothing_found"))},m=e=>{const{displayField:t,fieldAliases:a,attributes:n,symbol:s,numOfEntries:l}=e.selectedFeature,o=u(),{t:d}=c();return r((()=>{this.buttonPanel.panel.addActionButton("back",d("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{1===l?e.setPanel(!0,!1,!1):e.setPanel(!1,!0,!1)}))}),[]),i("div",{className:o.featureInfoContainer},i("div",{className:o.featureInfoHeader},i("div",{className:o.featureInfoHeaderIconContainer},s.imageData?i("img",{className:o.featureInfoHeaderIcon,src:`data:${s.contentType};base64, ${s.imageData}`}):i("div",{className:o.featureInfoHeaderIcon})),i("span",{className:o.featureInfoHeaderText},n[t].length>0?`${n[t]}`:`${n.OBJECTID}`)),i("div",{className:o.featureInfoItemsContainer},Object.keys(n).map((e=>{const t=a[e],s=n[e];return s.length>0&&"OBJECTID"!==t&&"SHAPE"!==t&&i("div",{className:o.featureInfoItem,key:e},i("span",{className:o.featureInfoItemKey},t),i("span",{className:o.featureInfoItemValue},s))}))))},g={tooltip:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},x={title:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',content:()=>{const[t,a]=l({}),[n,c]=l({}),[d,g]=l({}),[x,b]=l(!1),[h,I]=l(!1),[w,v]=l(!1),k=u(),C=e.map(s).map,N=async e=>{const t=await fetch(`${e}?f=json`);return await t.json()},P=(e,t,a)=>{this.buttonPanel.panel.removeActionButton("back"),b(e),I(t),v(a)},S=o((()=>{P(!0,!1,!1)}),[]),D=o((e=>{c(e),P(!1,!0,!1)}),[c]),T=o((e=>{g(e),P(!1,!1,!0)}),[g]),$=e=>{const t={};return e&&e.forEach((e=>{const{name:a,alias:n}=e;t[a]=n})),t},F=(e,t,a,n)=>{const{layers:s}=t[e.id];s[`${a.id}-${a.name.replace(/\s+/g,"-").toLowerCase()}`]={layer:a,groupLayer:n,layerData:[],displayField:a.displayField||a.displayFieldName||"",fieldAliases:$(a.fields),renderer:a.drawingInfo&&a.drawingInfo.renderer},t[e.id].layers=s},A=o(((e,n)=>{const s=t[e],{layers:i}=s;i[n].layerData=[],a((t=>({...t,[e]:{...t[e],layers:i}})))}),[t]),L=o((async e=>{const n=[];for(let s=0;s<Object.keys(t).length;s++){const i=Object.keys(t)[s],l=t[i],{layer:r,layers:o}=l;for(let t=0;t<Object.keys(o).length;t++){const s=Object.keys(o)[t];if(!o[s].groupLayer){A(i,s);const t=r._map.getSize(),l=r._map.getBounds(),c={xmin:l.getSouthWest().lng,ymin:l.getSouthWest().lat,xmax:l.getNorthEast().lng,ymax:l.getNorthEast().lat,spatialReference:{wkid:4326}},d=`${r.mapService.options.url}identify?f=json&tolerance=3&mapExtent=${c.xmin},${c.ymin},${c.xmax},${c.ymax}&imageDisplay=${t.x},${t.y},96&layers=visible:${o[s].layer.id}&returnFieldName=true&sr=4326&returnGeometry=true&geometryType=esriGeometryPoint&geometry=${e.lng},${e.lat}`,u=await fetch(d),p=await u.json();p&&p.results&&p.results.length>0&&(n.push({layer:o[s],entries:p.results}),o[s].layerData.push(...p.results),a((e=>({...e,[i]:{...e[i],layers:o}}))))}}}1===n.length?(D(n[0].layer),1===n[0].entries.length&&T({attributes:n[0].entries[0].attributes,displayField:n[0].layer.displayField,fieldAliases:n[0].layer.fieldAliases,symbol:p(n[0].layer.renderer,n[0].entries[0].attributes),numOfEntries:1})):S(),this.buttonPanel.panel.open()}),[T,D,S,A,t]);return r((()=>{const t=e.map(s).layers,n={};t.forEach((async e=>{if(n[e.id]={id:e.id,type:e.type,layer:e.layer,layers:{}},"ogcWMS"===e.type){const t=await N(e.layer.mapService.options.url+0);F(e,n,t,!1)}else if("esriFeature"===e.type){const t=await N(e.layer.options.url);F(e,n,t,!1)}else if("esriDynamic"===e.type){const t=e.layer.getLayers(),a={};t.forEach((e=>{a[e]=e})),e.layer.metadata((async(t,s)=>{if(!t&&s.layers)for(let t=0;t<s.layers.length;t++){const i=s.layers[t];if(i.id in a){const t=await N(e.layer.options.url+i.id);if(F(e,n,t,null!==i.subLayerIds&&void 0!==i.subLayerIds),i.subLayerIds)for(let t=0;t<i.subLayerIds.length;t++){const a=i.subLayerIds[t],s=await N(e.layer.options.url+a);F(e,n,s,!1)}}}}))}})),a(n)}),[]),r((()=>(C.on("click",(async e=>{L(e.latlng)})),e.event.on("details_panel/crosshair_enter",(function(e){e.handlerName===s&&L(e.latlng)}),s),()=>{C.off("click"),e.event.off("details_panel/crosshair_enter")})),[L,C]),i("div",{className:k.mainContainer},x&&i(f,{layersData:t,selectFeature:T,selectLayer:D}),h&&i(y,{selectedLayer:n,selectFeature:T,setPanel:P}),w&&i(m,{selectedFeature:d,setPanel:P}))},width:300};this.buttonPanel=e.map(s).createAppbarPanel(g,x,null)};removed=()=>{const{mapId:e}=this.props;this.api.map(e).removeAppbarPanel(this.buttonPanel.id)}};