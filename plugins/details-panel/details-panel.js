window.plugins=window.plugins||{},window.plugins.detailsPanel=class{buttonPanel=null;translations={"en-CA":{detailsPanel:"Details",nothing_found:"Nothing found",action_back:"Back"},"fr-CA":{detailsPanel:"Détails",nothing_found:"Aucun résultat",action_back:"Retour"}};added=()=>{const{api:e,react:a,makeStyles:t,translate:n}=this,{mapId:l}=this.props,r=this.createElement,{useState:s,useEffect:i,useCallback:o}=a,{useTranslation:c}=n,{language:d}=e.map(l),u=t((e=>({mainContainer:{display:"flex",flexDirection:"row"},layersContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},layerItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3,border:"none",width:"100%"},layerParentText:{fontSize:"16px",fontWeight:"bold"},layerCountTextContainer:{display:"flex",alignItems:"center",width:"100%"},layerFeatureCount:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)",marginRight:"10px",color:"black",fontSize:"16px",fontWeight:"bold"},layerItemText:{fontSize:"14px",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},featuresContainer:{overflow:"hidden",overflowY:"auto",width:"100%"},featureItem:{display:"flex",alignItems:"center",justifyContent:"space-between",margin:"5px 0",padding:"10px 5px",boxSizing:"content-box","&:hover":{cursor:"pointer",backgroundColor:"#c9c9c9"},zIndex:1e3},featureIconTextContainer:{display:"flex",alignItems:"center",width:"100%"},featureItemIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureItemIcon:{},featureItemText:{display:"inline-block",width:"100%",fontWeight:"400",marginLeft:"10px",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",fontSize:"16px"},featureInfoContainer:{width:"100%"},featureInfoHeader:{display:"flex",alignItems:"center"},featureInfoHeaderIconContainer:{display:"flex",justifyContent:"center",alignItems:"center",width:"32px",minWidth:"32px",height:"32px",boxShadow:"0 1px 3px 0 rgb(0 0 0 / 20%), 0 1px 1px 0 rgb(0 0 0 / 14%), 0 2px 1px -1px rgb(0 0 0 / 12%)"},featureInfoHeaderIcon:{},featureInfoHeaderText:{marginLeft:"10px",width:"100%",fontSize:18},featureInfoItemsContainer:{display:"flex",flexDirection:"column",marginTop:20},featureInfoItem:{display:"flex",flexDirection:"column",margin:"5px 0"},featureInfoItemKey:{fontWeight:"bold",fontSize:16},featureInfoItemValue:{fontSize:16,backgroundColor:"#ddd"}}))),f=(e,a)=>{let t=null;return e&&e.symbol?t=e.symbol:e&&e.uniqueValueInfos&&e.uniqueValueInfos.length>0&&(t=e.uniqueValueInfos.filter((t=>t.value===(a[e.field1]||a[e.field2]||a[e.field3])))[0].symbol),t},y=e=>{const a=u(),t=(a,t)=>{const{layerData:n,displayField:l,fieldAliases:r,renderer:s}=a.layers[t];e.selectLayer(a.layers[t]),1===n.length&&e.selectFeature({attributes:n[0].attributes,displayField:l,fieldAliases:r,symbol:f(s,n[0].attributes),numOfEntries:1})};return r("div",{className:a.layersContainer},Object.keys(e.layersData).map((n=>{const l=e.layersData[n];return r("div",{key:l.id},Object.keys(l.layers).map(((e,n)=>{const{layer:s,layerData:i,groupLayer:o}=l.layers[e];return r("div",{key:n,tabIndex:i.length>0&&!o?0:-1,onKeyDown:a=>{"Enter"===a.key&&(o||t(l,e))}},o?r("div",{className:a.layerParentText,title:s.name},s.name):r("button",{className:a.layerItem,disabled:0===i.length,onClick:i.length>0?a=>{t(l,e)}:null},r("div",{className:a.layerCountTextContainer},r("span",{className:a.layerFeatureCount},i.length),r("div",{className:a.layerItemText,title:s.name},s.name))))})))})))},m=e=>{const{displayField:a,fieldAliases:t,layerData:n,renderer:l}=e.selectedLayer,s=u(),{t:o}=c(),d=(l,r)=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{1===n.length?e.setPanel(!0,!1,!1):e.selectLayer()})),e.selectFeature({attributes:l,displayField:a,fieldAliases:t,symbol:r,numOfEntries:n.length})};return i((()=>{this.buttonPanel.panel.addActionButton("back",o("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{e.setPanel(!0,!1,!1)}))}),[]),n.length>0?r("div",{className:s.featuresContainer},n.map(((e,t)=>{const{attributes:n}=e,i=f(l,n),o=n[a].length>0?`${n[a]}`:`${n.OBJECTID}`;return r("div",{key:t,tabIndex:0,onKeyDown:e=>{"Enter"===e.key&&d(n,i)}},r("div",{className:s.featureItem,onClick:e=>{d(n,i)}},r("div",{className:s.featureIconTextContainer},r("div",{className:s.featureItemIconContainer},i.imageData?r("img",{className:s.featureItemIcon,src:`data:${i.contentType};base64, ${i.imageData}`}):l.symbol.legendImageUrl?r("img",{className:s.featureItemIcon,src:l.symbol.legendImageUrl}):r("div",{className:s.featureItemIcon})),r("span",{className:s.featureItemText,title:o},o))))}))):r("div",{className:s.featureItemText},o("nothing_found"))},p=e=>{const{displayField:a,fieldAliases:t,attributes:n,symbol:l,numOfEntries:s}=e.selectedFeature,o=u(),{t:d}=c();return i((()=>{this.buttonPanel.panel.addActionButton("back",d("action_back"),'<i class="material-icons">keyboard_backspace</i>',(()=>{1===s?e.setPanel(!0,!1,!1):e.setPanel(!1,!0,!1)}))}),[]),r("div",{className:o.featureInfoContainer},r("div",{className:o.featureInfoHeader},r("div",{className:o.featureInfoHeaderIconContainer},l.imageData?r("img",{className:o.featureInfoHeaderIcon,src:`data:${l.contentType};base64, ${l.imageData}`}):l.legendImageUrl?r("img",{className:o.featureInfoHeaderIcon,src:l.legendImageUrl}):r("div",{className:o.featureInfoHeaderIcon})),r("span",{className:o.featureInfoHeaderText},n[a].length>0?`${n[a]}`:`${n.OBJECTID}`)),r("div",{className:o.featureInfoItemsContainer},Object.keys(n).map((e=>{const a=t[e],l=n[e];return l.length>0&&"OBJECTID"!==a&&"SHAPE"!==a&&r("div",{className:o.featureInfoItem,key:e,tabIndex:0},r("span",{className:o.featureInfoItemKey},a),r("span",{className:o.featureInfoItemValue},l))}))))},g={id:"detailsPanel",tooltip:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',visible:!1},b={title:this.translations[d].detailsPanel,icon:'<i class="material-icons">details</i>',content:()=>{const[a,t]=s({}),[n,d]=s({}),[g,b]=s({}),[x,I]=s(!1),[h,w]=s(!1),[v,k]=s(!1),C=u(),{t:N}=c(),P=e.map(l).map,S=async e=>{const a=await fetch(`${e}?f=json`);return await a.json()},D=(e,a,t)=>{this.buttonPanel.panel.removeActionButton("back"),I(e),w(a),k(t)},$=o((()=>{D(!0,!1,!1)}),[]),T=o((e=>{d(e),D(!1,!0,!1)}),[d]),A=o((e=>{b(e),D(!1,!1,!0)}),[b]),F=e=>{const a={};return e&&e.forEach((e=>{const{name:t,alias:n}=e;a[t]=n})),a},E=(e,a,t,n)=>{const{layers:l}=a[e.id];l[`${t.id}-${t.name.replace(/\s+/g,"-").toLowerCase()}`]={layer:t,groupLayer:n,layerData:[],displayField:t.displayField||t.displayFieldName||"",fieldAliases:F(t.fields),renderer:t.drawingInfo&&t.drawingInfo.renderer},a[e.id].layers=l},L=o(((e,n)=>{const l=a[e],{layers:r}=l;r[n].layerData=[],t((a=>({...a,[e]:{...a[e],layers:r}})))}),[a]),_=o((async e=>{const n=[];for(let l=0;l<Object.keys(a).length;l++){const r=Object.keys(a)[l],s=a[r],{layer:i,layers:o}=s;for(let a=0;a<Object.keys(o).length;a++){const l=Object.keys(o)[a];if(!o[l].groupLayer){L(r,l);const a=i._map.getSize(),s=i._map.getBounds(),c={xmin:s.getSouthWest().lng,ymin:s.getSouthWest().lat,xmax:s.getNorthEast().lng,ymax:s.getNorthEast().lat,spatialReference:{wkid:4326}},d=`${i.mapService.options.url}identify?f=json&tolerance=3&mapExtent=${c.xmin},${c.ymin},${c.xmax},${c.ymax}&imageDisplay=${a.x},${a.y},96&layers=visible:${o[l].layer.id}&returnFieldName=true&sr=4326&returnGeometry=true&geometryType=esriGeometryPoint&geometry=${e.lng},${e.lat}`,u=await fetch(d),f=await u.json();f&&f.results&&f.results.length>0&&(n.push({layer:o[l],entries:f.results}),o[l].layerData.push(...f.results),t((e=>({...e,[r]:{...e[r],layers:o}}))))}}}1===n.length?(T(n[0].layer),1===n[0].entries.length&&A({attributes:n[0].entries[0].attributes,displayField:n[0].layer.displayField,fieldAliases:n[0].layer.fieldAliases,symbol:f(n[0].layer.renderer,n[0].entries[0].attributes),numOfEntries:1})):$(),this.buttonPanel.panel.open();const l=document.querySelectorAll(`[data-id=${this.buttonPanel.id}]`)[0];l&&l.querySelectorAll(".cgpv-panel-close")[0].focus()}),[A,T,$,L,a]);return i((()=>{const a=e.map(l).layers,n={};a.forEach((async e=>{if(n[e.id]={id:e.id,type:e.type,layer:e.layer,layers:{}},"ogcWMS"===e.type){const{entries:a}=e.layer;for(let t=0;t<a.length;t++){const l=a[t],r=await S(e.layer.mapService.options.url+l),s=`${e.layer._url}?request=GetLegendGraphic&version=1.0.0&Service=WMS&format=image/png&layer=${l}`;r.drawingInfo&&r.drawingInfo.renderer&&r.drawingInfo.renderer.symbol&&Object.defineProperties(r.drawingInfo.renderer.symbol,{legendImageUrl:{value:s}}),E(e,n,r,!1)}}else if("esriFeature"===e.type){const a=await S(e.layer.options.url);E(e,n,a,!1)}else if("esriDynamic"===e.type){const a=e.layer.getLayers(),t={};a.forEach((e=>{t[e]=e})),e.layer.metadata((async(a,l)=>{if(!a&&l.layers)for(let a=0;a<l.layers.length;a++){const r=l.layers[a];if(r.id in t){const a=await S(e.layer.options.url+r.id);if(E(e,n,a,null!==r.subLayerIds&&void 0!==r.subLayerIds),r.subLayerIds)for(let a=0;a<r.subLayerIds.length;a++){const t=r.subLayerIds[a],l=await S(e.layer.options.url+t);E(e,n,l,!1)}}}}))}})),t(n)}),[]),i((()=>(P.on("click",(async e=>{_(e.latlng)})),e.event.on("details_panel/crosshair_enter",(function(e){e.handlerName===l&&_(e.latlng)}),l),()=>{P.off("click"),e.event.off("details_panel/crosshair_enter")})),[_,P]),r("div",{className:C.mainContainer},x&&r(y,{layersData:a,selectFeature:A,selectLayer:T}),h&&r(m,{selectedLayer:n,selectFeature:A,setPanel:D}),v&&r(p,{selectedFeature:g,setPanel:D}))},width:300};this.buttonPanel=e.map(l).createAppbarPanel(g,b,null)};removed=()=>{const{mapId:e}=this.props;this.api.map(e).removeAppbarPanel(this.buttonPanel.id)}};